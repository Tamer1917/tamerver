import telebot
import requests
import firebase_admin
from firebase_admin import credentials, db

# ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­

cred = credentials.Certificate(r"C:\Users\LENOVO\Desktop\frapp\serviceAccountKey.json")


firebase_admin.initialize_app(cred, {
    'databaseURL': 'https://mychessgame-7811e-default-rtdb.europe-west1.firebasedatabase.app/'
})

# ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
BOT_TOKEN = "7996338110:AAGKkgFy1qpUQG4E9A4ZJrgc0aon4cx8JpI"
bot = telebot.TeleBot(BOT_TOKEN)

# ğŸ”¹ Ø±Ø§Ø¨Ø· ØµÙØ­Ø© HTML Ø§Ù„Ù…Ø³ØªØ¶Ø§ÙØ© Ø¹Ù„Ù‰ Vercel (ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙƒ API Endpoint Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
VERCEL_URL = "https://fernew1.vercel.app/update-score"

@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    username = message.from_user.username or f"User_{user_id}"  # ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…

    # Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    ref = db.reference(f'users/{username}')
    user_data = ref.get()

    if user_data is None:
        # ğŸ”¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ØŒ Ù†Ø¶ÙŠÙÙ‡ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ 5 Ù†Ù‚Ø§Ø·
        user_data = {"username": username, "points": 5}
        ref.set(user_data)
    else:
        # ğŸ”¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        user_data["points"] = user_data.get("points", 0)

    # ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… (Vercel)
    try:
        response = requests.post(VERCEL_URL, json=user_data)
        response.raise_for_status()  # Ø±ÙØ¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø¯
        bot.reply_to(message, f"Ù…Ø±Ø­Ø¨Ù‹Ø§ {username}! Ù„Ø¯ÙŠÙƒ {user_data['points']} Ù†Ù‚Ø·Ø©.")
        print("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")
    except requests.exceptions.RequestException as e:
        print(f"âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        bot.reply_to(message, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù….")

# ğŸ”¹ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot.polling(none_stop=True)
